<!-- dashboard.html -->
<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YÃ¶netici Paneli</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>
    <div class="header">
        YÃ¶netici EkranÄ±
    </div>

    <div class="main-container">
        <!-- Sol Panel (MenÃ¼) -->
        <div class="sidebar">
            <div>
                <h2>KonteynÄ±rlar</h2>
                <ul>
                    <li><a href="{{ url_for('konteyner_ekle_secim') }}">Ekle</a></li>
                    <li>KonteynÄ±r Sil</li>
                    <li>KonteynÄ±r DÃ¼zenle</li>
                    <li><a href="{{ url_for('konteyner_talepler') }}">KonteynÄ±r Talepleri</a></li>
                </ul>
                <h2>HastalÄ±k</h2>
                <h2>Acil Ã‡aÄŸrÄ± GeÃ§miÅŸi</h2>
                <ul>
                    <li><a href="{{ url_for('emergency_history') }}">GeÃ§miÅŸ KayÄ±tlar</a></li>
                </ul>
            </div>
            <div>
                <div class="profile">
                    <div class="profile-picture"></div>
                    <div class="profile-info">
                        <p>{{ user.name }}</p>
                    </div>
                </div>
                <div class="logout">
                    <a href="{{ url_for('logout') }}"><button>Ã‡Ä±kÄ±ÅŸ Yap</button></a>
                </div>
            </div>
        </div>

        <!-- Orta Alan (Harita) -->
        <div class="content">
            <div id="map"></div>
        </div>

        <!-- SaÄŸ Panel -->
        <div class="right-panel">
            <h2>Acil Ã‡aÄŸrÄ±lar</h2>
            <div class="emergency-list">
                {% for cagri in acil_cagrilar %}
                <div class="emergency-card" 
                     data-lat="{{ cagri[4] }}" 
                     data-lng="{{ cagri[5] }}"
                     data-id="{{ cagri[0] }}">
                    <div class="emergency-header">
                        <span class="emergency-type {{ cagri[2].lower() }}">{{ cagri[2] }}</span>
                        <span class="emergency-time">{{ cagri[6].strftime('%H:%M') }}</span>
                    </div>
                    <div class="emergency-content">
                        <p><strong>Ä°ÅŸÃ§i:</strong> {{ cagri[1] }}</p>
                        {% if cagri[3] %}
                        <p><strong>AÃ§Ä±klama:</strong> {{ cagri[3] }}</p>
                        {% endif %}
                    </div>
                    <div class="emergency-actions">
                        <button class="show-location-btn" onclick="showEmergencyLocation('{{ cagri[4] }}', '{{ cagri[5] }}', '{{ cagri[2] }}')">
                            Konumu GÃ¶ster
                        </button>
                        <button class="resolve-btn" onclick="resolveEmergency('{{ cagri[0] }}')">
                            Ã‡Ã¶zÃ¼ldÃ¼
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>

            <h2>Ã‡Ã¶zÃ¼len Ã‡aÄŸrÄ±lar</h2>
            <div class="processing-list">
                {% for cagri in islemdeki_cagrilar %}
                <div class="emergency-card processing">
                    <div class="emergency-header">
                        <span class="emergency-type {{ cagri[2].lower() }}">{{ cagri[2] }}</span>
                        <span class="emergency-time">{{ cagri[6].strftime('%d.%m %H:%M') }}</span>
                    </div>
                    <div class="emergency-content">
                        <p><strong>Ä°ÅŸÃ§i:</strong> {{ cagri[1] }}</p>
                        {% if cagri[3] %}
                        <p><strong>AÃ§Ä±klama:</strong> {{ cagri[3] }}</p>
                        {% endif %}
                        <p><strong>Ã‡Ã¶zen:</strong> {{ cagri[7] }}</p>
                        {% if cagri[8] %}
                        <p><strong>Ã‡Ã¶zÃ¼m Notu:</strong> {{ cagri[8] }}</p>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // HaritayÄ± baÅŸlat
        var map = L.map('map').setView([40.1825, 29.0664], 10);  // VarsayÄ±lan merkez
    
        // Harita katmanÄ±nÄ± ekle
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
    
        // URL'den koordinatlarÄ± al
        const urlParams = new URLSearchParams(window.location.search);
        const lat = parseFloat(urlParams.get('lat'));
        const lng = parseFloat(urlParams.get('lng'));
    
        // EÄŸer URL'de koordinat varsa
        if (lat && lng) {
            // Varsa Ã¶nceki marker'Ä± temizle
            if (window.currentMarker) {
                map.removeLayer(window.currentMarker);
            }
    
            // Yeni marker ekle
            window.currentMarker = L.marker([lat, lng]).addTo(map)
                .bindPopup("Konteyner burada!").openPopup();
    
            // HaritayÄ± konuma odakla
            map.setView([lat, lng], 15);
        }
        let currentEmergencyMarker = null;

        function showEmergencyLocation(lat, lng, type) {
            // EÄŸer Ã¶nceki marker varsa kaldÄ±r
            if (currentEmergencyMarker) {
                map.removeLayer(currentEmergencyMarker);
            }

            // Acil durum tipine gÃ¶re icon seÃ§
            let icon = 'ðŸš¨';
            if (type.toLowerCase() === 'yangÄ±n') icon = 'ðŸ”¥';
            else if (type.toLowerCase() === 'deprem') icon = 'âš ï¸';
            else if (type.toLowerCase() === 'sel') icon = 'ðŸ’§';

            // Yeni marker ekle
            currentEmergencyMarker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'emergency-marker',
                    html: icon
                })
            }).addTo(map);

            // HaritayÄ± konuma odakla
            map.setView([lat, lng], 15);
        }

        function resolveEmergency(emergencyId) {
            if (confirm('Bu acil Ã§aÄŸrÄ±yÄ± Ã§Ã¶zÃ¼ldÃ¼ olarak iÅŸaretlemek istediÄŸinize emin misiniz?')) {
                const notes = prompt('Ã‡Ã¶zÃ¼m notlarÄ±nÄ± giriniz (opsiyonel):');
                
                fetch('/resolve-emergency', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        emergency_id: emergencyId,
                        notes: notes
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Ä°ÅŸlem baÅŸarÄ±sÄ±z: ' + (data.error || 'Bilinmeyen hata'));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Bir hata oluÅŸtu!');
                });
            }
        }

        // Her 30 saniyede bir acil Ã§aÄŸrÄ±larÄ± gÃ¼ncelle
        setInterval(() => {
            location.reload();
        }, 30000);
    </script>
</body>
</html>